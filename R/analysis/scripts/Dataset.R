###########################################################################
#
#  Experiment:  GENUINE
#  Programmer:  QUETTIER THOMAS
#  Date:        23/01/2024
# Description: This script aggregates all .csv files generated by PsychoPy
#              and compiles them into a single .RData file for streamlined analysis.
#
#  Update:      12/11/2024
###########################################################################

# Clearing workspace
rm(list=ls()) # Clear the existing workspace to avoid conflicts

# Load dependencies
devtools::load_all() # Load necessary functions and packages

 folder_dir <- "original_data/psychopy"
 
# list.files(path = folder_dir, full.names = TRUE) %>%
#   lapply(function(filepath) {
#     # Read the CSV file
#     data <- read.csv(filepath)
# 
#     # Check if the target column exists
#     if (!"education" %in% colnames(data)) {
#       stop("The specified column does not exist in the CSV file.")
#     }
# 
#     # Replace the values in the target column
#     data[["education"]] <- NA
# 
#     # Write the modified data frame back to the original file
#     write.csv(data, filepath, row.names = FALSE)
# 
#     cat("The values in column 'education' have been replaced with NA.\nFile saved at:", filepath, "\n")
#   })


# Data loading
datasetname <-  "psychopy_dataset"
dataset_concatenation(folder_dir,datasetname) # aggregates all .csv files
load(paste0("data/",datasetname,".RData") )

# Count participants
n <- length(unique(dataset$participant)) # Calculate the number of unique participants

# Assign participants to groups based on the chronological order of data collection
treatment_group <- c(1,2,3,4,5,11,12,13,14,17,19,22,25,26,27,37)
control_group <- c(6,7,8,9,10,15,16,18,20,21,23,24,28,29,30,39,47,48)
m1_group <- c(31,32,33,34,35,36,38,40,41,42,43,44,45,46,49,53)
sham <- c(50,51,52,59,60,61,62,63,64,67,69,73,79,80,81,82)
m1_inv <- c(54,55,56,57,58,65,66,68,70,71,72,74,75,76,77,78)
# Modify the dataset
dataset <- dataset %>%
  # Mutate the 'ccPAS' and 'Group' columns based on participant groups
  mutate(ccPAS = ifelse(participant %in% control_group, "STS_IFG", 
                        ifelse(participant %in% m1_group, "M1_IFG", "IFG_STS")),
         Group = case_when(participant %in% control_group ~ "Exp1rpSTS-rIFG", 
                           participant %in% m1_group ~ "Exp2rIFG-rM1",
                           participant %in% treatment_group ~ "Ctrl1rIFG-rpSTS",
                           participant %in% sham ~ "sham",
                           participant %in% m1_inv ~ "Ctrl2rM1-rIFG")) %>%
  # Filter rows to include only the first repetition of each trial
  filter(Trials_loop.thisRepN == 0) %>%
  # Mutate 'Emotion', 'group', and 'Session' columns for consistency
  mutate(Emotion = case_when(emotion == "anger" ~ "Anger",
                             emotion == "fear" ~ "Fearful",
                             emotion == "happiness" ~ "Happiness"),
         emotion = factor(Emotion, levels = c("Anger", "Fearful", "Happiness")),
         group = factor(Group, levels = c("Exp1rpSTS-rIFG", "Ctrl1rIFG-rpSTS", "Exp2rIFG-rM1", "Ctrl2rM1-rIFG","sham")),
         Session = case_when(session == 1 ~ "baseline",
                             session == 2 ~ "T0",
                             session == 3 ~ "T20"),
         session = factor(Session, levels = c("baseline", "T0", "T20"))) %>%
  # Standardize 'gender' values
  mutate(gender = ifelse(tolower(gender) == "m", "male", "female"),
         Pt.id = sprintf("%02d", as.integer(participant)) # Ensure two-digit format
  ) %>%
  # Select and rename columns for the final dataset
  select(
    File.name = file,
    File.emotion = emotion,
    File.elicitation = elicitation,
    Pt.id,
    Pt.age = eta,
    Pt.gender = gender,
    Pt.ccPAS = ccPAS,
    Pt.group = group,
    AED.accuracy = gesino_kb.corr,
    AED.resp = gesino_kb.keys,
    AED.intensity = genuine_slider.response,
    AED.rt = gesino_kb.rt,
    EIJ.accuracy = accuracy,
    EIJ.label = emotion_ms.clicked_name, 
    EIJ.intensity = intensity_slider.response,
    Exp.date = date, 
    Exp.session = session,
    Exp.name = expName,
    Exp.version = psychopyVersion,
    Exp.frameRate = frameRate
   ) %>%
   filter(
     Pt.id != 15, Pt.id != 23 ) %>%
  filter( Pt.group != "sham") %>%
  mutate(Pt.group = factor(Pt.group, levels = c("Exp1rpSTS-rIFG", "Ctrl1rIFG-rpSTS", "Exp2rIFG-rM1", "Ctrl2rM1-rIFG")))



# data for EAD
emotion_accuracy <- dataset %>%
  group_by(Pt.id,Pt.group,Exp.session,File.emotion, File.elicitation) %>%
  summarise(accuracy = mean(EIJ.accuracy,na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(label = paste0(Exp.session,".",File.emotion,".",File.elicitation)) %>%
  select(-c(File.emotion,Exp.session,File.elicitation)) %>%
  spread(label, accuracy) %>%
  arrange(Pt.group) 

genuine_accuracy <- dataset %>%
  group_by(Pt.id,Pt.group,Exp.session,File.emotion, File.elicitation) %>%
  summarise(accuracy = mean(AED.accuracy,na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(label = paste0(Exp.session,".",File.emotion,".",File.elicitation)) %>%
  select(-c(File.emotion,Exp.session,File.elicitation)) %>%
  spread(label, accuracy) %>%
  arrange(Pt.group) 


# Calculating hits, misses, false alarms, and correct rejections
SDT_genuine <- dataset %>%
  GenuineDetection() 


# Relation between changes in the AED and dispositional empathy or alexithymic traits
Questionnaires<-questionnaires("original_data/questionnaire.csv",subjectorder,",")

# IRI TAS summary
IRI<-Questionnaires%>%
  select(Pt.id, iri_tot)%>%
  drop_na()%>%
  summarise_at(vars(iri_tot), list(mean,sd,max,min))%>%
  'colnames<-'(c( "mean", "Sd","max","min"))

TAS<-Questionnaires%>%
  select(Pt.id, tas_tot)%>%
  drop_na()%>%
  summarise_at(vars( tas_tot), list(mean,sd,max,min))%>%
  'colnames<-'(c( "mean", "Sd","max","min"))

Questionnaires$Pt.id <- sprintf("%02d", as.integer(Questionnaires$Pt.id))

Questionnaires <- Questionnaires %>%
  arrange(subject)

summary_genuine <- SDT_genuine %>%
  mutate(SessionGroup = case_when(
    Exp.session == "baseline" ~ "baseline",
    Exp.session != "baseline" ~ "post"
  )) %>%
  group_by(Pt.id, SessionGroup, Pt.group) %>%
  summarise(d_prime = mean(d_prime, na.rm = TRUE),
            c = mean(c, na.rm = TRUE)) %>%
  pivot_wider(names_from = SessionGroup, values_from = c(d_prime, c)) %>%
  mutate(d_delta = d_prime_post - d_prime_baseline,
         c_delta = c_post - c_baseline) %>%
  select(Pt.id, Pt.group, d_delta, c_delta)
Questionnaire<-Questionnaires %>%
  select(Pt.id,fantasy,perspective_taking,empathic_concern,personal_distress,iri_tot,tas_tot,subject)

Questionnaire <- Questionnaires %>%
    select(Pt.id,fantasy,perspective_taking,empathic_concern,personal_distress,iri_tot,tas_tot,subject)

ΓAED <- left_join(summary_genuine, Questionnaire, by = "Pt.id") %>%
  drop_na() %>% select(-c(subject,Pt.id))%>%
  arrange(Pt.group)

d_wide <- SDT_genuine %>%
  select( Pt.id, Pt.group, Exp.session, File.emotion, d_prime ) %>%
  mutate( label = paste0(Exp.session,".", File.emotion)) %>%
  ungroup()%>%
  select(-c(Exp.session, File.emotion)) %>%
  spread(label, d_prime) %>%
  arrange(Pt.group)

c_wide <- SDT_genuine %>%
  select( Pt.id, Pt.group, Exp.session, File.emotion, c ) %>%
  mutate( label = paste0(Exp.session,".", File.emotion)) %>%
  ungroup()%>%
  select(-c(Exp.session, File.emotion)) %>%
  spread(label, c) %>%
  arrange(Pt.group)

# data for EIJ
autoevaluation <- read_excel("original_data/autovalutazione_clips.xlsx") %>%
  select(-Emotion) %>%
  'colnames<-'(c( "File.elicitation", "File.name","autoval"))

data <-  dataset %>%
  select(Pt.id, File.emotion, Pt.group,Exp.session, EIJ.intensity, File.name) 

EA_dataset <- left_join(autoevaluation,data,by = "File.name") %>%
  drop_na()%>%
  filter(File.elicitation != "paused") %>%
  group_by(Pt.id, File.emotion, Exp.session, Pt.group) %>%
  summarise(EA = cor(EIJ.intensity,autoval),
            EIJ.intensity = mean(EIJ.intensity, na.rm =TRUE),
            autoval= mean(autoval, na.rm =TRUE))

genuine_intensity <- dataset %>% 
  filter(EIJ.accuracy == 1)%>%
  group_by(Pt.id, File.emotion, Pt.group,Exp.session) %>%
  summarise(slider = mean(abs(AED.intensity), na.rm = TRUE)) %>%
  mutate( label = paste0(Exp.session,".", File.emotion)) %>%
  ungroup()%>%
  select(-c(Exp.session, File.emotion)) %>%
  spread(label, slider) %>%
  arrange(Pt.group)


emotion_intensity <- dataset %>%
  group_by(Pt.id, File.emotion, Pt.group,Exp.session) %>%
  summarise(slider = mean(EIJ.intensity)) %>%
  mutate( label = paste0(Exp.session,".", File.emotion)) %>%
  ungroup()%>%
  select(-c(Exp.session, File.emotion)) %>%
  spread(label, slider) %>%
  arrange(Pt.group)

EA <- EA_dataset %>%
  select( Pt.id, Pt.group, Exp.session, File.emotion, EA ) %>%
  mutate( label = paste0(Exp.session,".", File.emotion)) %>%
  ungroup()%>%
  select(-c(Exp.session, File.emotion)) %>%
  spread(label, EA) %>%
  arrange(Pt.group)

demography <- dataset %>%
  filter(Exp.session == "baseline",
         File.name == "1_rg_2.mp4") %>%
  select( Pt.group, Pt.id, Pt.gender, Pt.age) %>%
  arrange(Pt.group)


# Save the data in .RData format
save(dataset, emotion_accuracy, genuine_accuracy, SDT_genuine, d_wide,c_wide, ΓAED,
     EA_dataset, genuine_intensity, emotion_intensity, EA, demography,
     file = paste0("data/",datasetname,".RData"))

# write_csv(dataset, 
#           file = paste0("data/",datasetname,".csv"))
#################################################
# 
# END
#
#################################################
#  Script for Genuine Study - Dataset
#################################################   